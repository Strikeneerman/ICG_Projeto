<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title> 3D scene </title>

    <link rel="stylesheet" href="style.css">

    <script type="importmap">
        {
          "imports": {
            "three": "https://threejs.org/build/three.module.js",
            "three/addons/": "https://threejs.org/examples/jsm/"
          }
        }
      </script>

    <script type="module">

        import * as THREE from "three";

        import { OrbitControls } from "three/addons/controls/OrbitControls.js";

        // To store the scene graph, and elements usefull to rendering the scene
        const sceneElements = {
            sceneGraph: null,
            camera: null,
            control: null,  // NEW
            renderer: null,
        };

        // HELPER FUNCTIONS

        const helper = {

            initEmptyScene: function (sceneElements) {

                // ************************** //
                // Create the 3D scene
                // ************************** //
                sceneElements.sceneGraph = new THREE.Scene();

                // ************************** //
                // Add camera
                // ************************** //
                const width = window.innerWidth;
                const height = window.innerHeight;
                const camera = new THREE.OrthographicCamera( width / -90, width / 90, height / 90, height / -90, 1 , 2000 )
                sceneElements.camera = camera;
                camera.position.set(0, 5, 6);
                camera.lookAt(0, 0, 0);
				//camera.zoom = 2;
				//camera.updateProjectionMatrix();

                // ************************** //
                // Illumination
                // ************************** //
				
                // ************************** //
                // Add ambient light
                // ************************** //
                const ambientLight = new THREE.AmbientLight('rgb(255, 255, 255)', 0.2);
                sceneElements.sceneGraph.add(ambientLight);
				
                // ***************************** //
                // Add spotlight (with shadows)
                // ***************************** //
                const spotLight1 = new THREE.SpotLight('rgb(255, 255, 255)', 20);
                spotLight1.decay = 1;
                spotLight1.position.set(10, 8, 5);
                sceneElements.sceneGraph.add(spotLight1);

                // Setup shadow properties for the spotlight
                spotLight1.castShadow = true;
                spotLight1.shadow.mapSize.width = 2048;
                spotLight1.shadow.mapSize.height = 2048;

                // Give a name to the spot light
                spotLight1.name = "light 1";
				
                // *********************************** //
                // Create renderer (with shadow map)
                // *********************************** //
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                sceneElements.renderer = renderer;
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setClearColor('rgb(255, 255, 150)', 1.0);
                renderer.setSize(width, height);

                // Setup shadowMap property
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                // **************************************** //
                // Add the rendered image in the HTML DOM
                // **************************************** //
                const htmlElement = document.querySelector("#Tag3DScene");
                htmlElement.appendChild(renderer.domElement);

                // ************************** //
                // NEW --- Control for the camera
                // ************************** //
                sceneElements.control = new OrbitControls(camera, renderer.domElement);
                sceneElements.control.screenSpacePanning = true;

            },

            render: function (sceneElements) {
                sceneElements.renderer.render(sceneElements.sceneGraph, sceneElements.camera);
            },
        };

        // FUCNTIONS FOR BUILDING THE SCENE

        const scene = {

			createArena: function(){

				const arena = new THREE.Object3D();

				arena.position.set(0,0,0);

				// ************************** //
				// Create the ground 
				// ************************** //
				const groundGeometry = new THREE.PlaneGeometry(14, 10);
				const groundMaterial = new THREE.MeshPhongMaterial({ color: 'rgb(200, 200, 200)', side: THREE.DoubleSide });
				const groundObject = new THREE.Mesh(groundGeometry, groundMaterial);

				// Change orientation of the ground using rotation
				groundObject.rotateOnAxis(new THREE.Vector3(1, 0, 0), Math.PI / 2);

				// Set shadow property
				groundObject.receiveShadow = true;

				arena.add(groundObject)

				// ************************** //
				// Create a wall
				// ************************** //
				const wallGeometry = new THREE.PlaneGeometry(14, 3);
				const wallMaterial = new THREE.MeshPhongMaterial({ color: 'rgb(200, 200, 200)', side: THREE.DoubleSide });
				const wallObject = new THREE.Mesh(wallGeometry, wallMaterial);

				wallObject.position.z = -5
				wallObject.position.y = 1.5

				// Set shadow property
				wallObject.receiveShadow = true;

				arena.add(wallObject);

				// ************************** //
				// Create the other wall
				// ************************** //
				const wall2Geometry = new THREE.PlaneGeometry(10, 3);
				const wall2Material = new THREE.MeshPhongMaterial({ color: 'rgb(200, 200, 200)', side: THREE.DoubleSide });
				const wall2Object = new THREE.Mesh(wall2Geometry, wall2Material);

				wall2Object.position.x = 7
				wall2Object.position.y = 1.5
				wall2Object.rotation.y = 0.5 * Math.PI;

				// Set shadow property
				wall2Object.receiveShadow = true;

				arena.add(wall2Object);


				const character = scene.createCharacter();

				arena.add(character);

				character.name = "player";

				return arena


			},


			createCharacter: function(){

				const character = new THREE.Object3D();

				character.position.set(0,0,0);

				// ************************** //
                // Create a cube
                // ************************** //
                // Cube center is at (0,0,0)

				const cubeWidth = 1;
				const cubeHeight = 1;
				const cubeDepth = 1;


                const cubeGeometry = new THREE.BoxGeometry(cubeWidth, cubeHeight, cubeDepth);
                const cubeMaterial = new THREE.MeshPhongMaterial({ color: 'rgb(255,0,0)' });
                const cubeObject = new THREE.Mesh(cubeGeometry, cubeMaterial);
                character.add(cubeObject);

                // Set position of the cube
                // The base of the cube will be on the plane 
                cubeObject.translateY(0.5);
				cubeObject.translateX(0);
				cubeObject.translateZ(0);

				//cubeObject.rotation.y = -0.25 * Math.PI;

                // Set shadow property
                cubeObject.castShadow = true;
                cubeObject.receiveShadow = true;

				// ************************** //
                // Create a cube head
                // ************************** //


				const headGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
                const headMaterial = new THREE.MeshPhongMaterial({ color: 'rgb(255,255,0)' });
                const headObject = new THREE.Mesh(headGeometry, headMaterial);
                character.add(headObject);

                // Set position of the head

                headObject.translateY(1.25);

				//headObject.rotation.y = -0.25 * Math.PI;

                // Set shadow property
                headObject.castShadow = true;
                headObject.receiveShadow = true;

				// ************************** //
                // Create an arm
                // ************************** //

				const armLength = 1;
				const armMuscle = 0.3;

				const armGeometry = new THREE.BoxGeometry(armLength, 0.3, armMuscle);
                const armMaterial = new THREE.MeshPhongMaterial({ color: 'rgb(255,255,0)' });
                const armObject = new THREE.Mesh(armGeometry, armMaterial);
                character.add(armObject);

                // Set position of the arm

                armObject.translateY(0.5);
				armObject.translateZ(0.65);
				armObject.translateX(0.65);

				//armObject.rotation.y = -0.25 * Math.PI;

                // Set shadow property
                armObject.castShadow = true;
                armObject.receiveShadow = true;

				// ************************** //
                // Create the other arm
                // ************************** //

				const arm2Geometry = new THREE.BoxGeometry(armLength, 0.3, armMuscle);
                const arm2Material = new THREE.MeshPhongMaterial({ color: 'rgb(255,255,0)' });
                const arm2Object = new THREE.Mesh(arm2Geometry, arm2Material);
                character.add(arm2Object);

                // Set position of the arm

                arm2Object.translateY(0.5);
				arm2Object.translateZ(-0.65);
				arm2Object.translateX(0.65);

				//armObject.rotation.y = -0.25 * Math.PI;

                // Set shadow property
                arm2Object.castShadow = true;
                arm2Object.receiveShadow = true;


				const characterBack = cubeObject.position.x - cubeWidth/2;
				const characterFront = cubeObject.position.x + armLength;
				const characterRight = cubeObject.position.x + (cubeDepth/2 + armMuscle);
				const characterLeft = cubeObject.position.x - (cubeDepth/2 + armMuscle);

				

				return character;
			},



            // Create and insert in the scene graph the models of the 3D scene

            load3DObjects: function (sceneGraph) {

				// ************************** //
                // Create the arena
                // ************************** //

				const arena = scene.createArena();

				arena.rotation.y = 0.25 * Math.PI;

				sceneGraph.add(arena);

				
				// ************************** //
                // Create the character
                // ************************** //

				//const character = scene.createCharacter();

				//sceneGraph.add(character);

				//character.name = "player";

            }
        };

        // ANIMATION

        // Displacement values
        var dispX = 0.05, dispZ = 0.05;

        //To keep track of the keyboard - WASD
        var keyD = false, keyA = false, keyS = false, keyW = false, keyQ = false, keyE = false;

        function computeFrame(time) {

            // CONTROLING THE CUBE WITH THE KEYBOARD

            const player = sceneElements.sceneGraph.getObjectByName("player");

            if (keyD && (player.position.x < 3 || player.position.z < 3)) {
                player.translateZ(dispX);
            }
            if (keyW && (player.position.x < 4.5 || player.position.z > -4.5)) {
                player.translateX(dispZ);
            }
            if (keyA && (player.position.x > -3 || player.position.z > -3)) {
                player.translateZ(-dispX);
            }
            if (keyS && (player.position.x > -4.5 || player.position.z < 4.5)) {
                player.translateX(-dispZ);
            }
            if (keyQ) {
                player.rotateOnAxis(new THREE.Vector3(0, 1, 0),0.05)
            }
            if (keyE) {
                player.rotateOnAxis(new THREE.Vector3(0, -1, 0),0.05)
            }

            // Rendering
            helper.render(sceneElements);

            // Animation
            //Call for the next frame
            requestAnimationFrame(computeFrame);
        }

        // Call functions:
        //  1. Initialize the empty scene
        //  2. Add elements within the scene
        //  3. Animate

        function init() {
            helper.initEmptyScene(sceneElements);
            scene.load3DObjects(sceneElements.sceneGraph);
            requestAnimationFrame(computeFrame);
        }

        // HANDLING EVENTS

        // Event Listeners

        window.addEventListener('resize', resizeWindow);

        document.addEventListener('keydown', onDocumentKeyDown, false);
        document.addEventListener('keyup', onDocumentKeyUp, false);

        // Update render image size and camera aspect when the window is resized
        function resizeWindow(eventParam) {
            const width = window.innerWidth;
            const height = window.innerHeight;

            sceneElements.camera.aspect = width / height;
            sceneElements.camera.updateProjectionMatrix();

            sceneElements.renderer.setSize(width, height);

            // Comment when doing animation
            // computeFrame(sceneElements);
        }

        function onDocumentKeyDown(event) {
            switch (event.keyCode) {
                case 68: //d
                    keyD = true;
                    break;
                case 83: //s
                    keyS = true;
                    break;
                case 65: //a
                    keyA = true;
                    break;
                case 87: //w
                    keyW = true;
                    break;
                case 69: //a
                    keyE = true;
                    break;
                case 81: //w
                    keyQ = true;
                    break;
                
            }
        }

        function onDocumentKeyUp(event) {
            switch (event.keyCode) {
                case 68: //d
                    keyD = false;
                    break;
                case 83: //s
                    keyS = false;
                    break;
                case 65: //a
                    keyA = false;
                    break;
                case 87: //w
                    keyW = false;
                    break;
                case 69: //a
                    keyE = false;
                    break;
                case 81: //w
                    keyQ = false;
                    break;
            }
        }


        // STARTING

        init();

    </script>

</head>

<body>
    <div id="Tag3DScene"> </div>
</body>

</html>